

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fitting of EPR Spectra with MarS &mdash; MarS 2026.01.11 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css?v=2aa19091" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=7e9183e1"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Advance Fitting Procedures" href="../example_4.html" />
    <link rel="prev" title="Fitting Procedures" href="../example_3.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            MarS
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quick Start</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contents/base_spin_system.html">Base Spin System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contents/sample.html">Sample Representation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contents/spectrum_constraction.html">EPR Spectrum Construction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contents/fitting_tutorial.html">Fitting Spectroscopic Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contents/interactions/index.html">Interactions in MarS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contents/populators/index.html">Population Computation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contents/context/index.html">Relaxation Context</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contents/spectra_creators/index.html">Spectra Creators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contents/intensity_calculators/index.html">Transition Intensity Calculation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contents/meshers/index.html">Meshing Strategies</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/mars.html">mars package</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorial Examples</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../example_1.html">Continuous-Wave EPR Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../example_2.html">Polarized Radiation EPR Simulation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../example_3.html">Fitting Procedures</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Fitting of EPR Spectra with MarS</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#1.-Introduction-to-EPR-Spectral-Fitting">1. Introduction to EPR Spectral Fitting</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#2.-Generating-Synthetic-Data">2. Generating Synthetic Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#3.-Setting-Up-the-Parameter-Space-for-Optimization">3. Setting Up the Parameter Space for Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="#4.-Fitting-procedures">4. Fitting procedures</a></li>
<li class="toctree-l2"><a class="reference internal" href="#5.-Fitting-methods">5. Fitting methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="#6.-Multi-Spectra-Fitting">6. Multi Spectra Fitting</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../example_4.html">Advance Fitting Procedures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../example_5.html">Spectra Polarization and Time Resolved</a></li>
<li class="toctree-l1"><a class="reference internal" href="../example_6.html">Multi-System Kinetic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../example_7.html">Time-Resolved Fitting Procedures</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Project Info</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/ArkadySamsonenkoWork/MarS.git"> GitHub Repository</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">MarS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../example_3.html">Fitting Procedures</a></li>
      <li class="breadcrumb-item active">Fitting of EPR Spectra with MarS</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/examples/examples_for_documentation/example_3.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Fitting-of-EPR-Spectra-with-MarS">
<h1>Fitting of EPR Spectra with MarS<a class="headerlink" href="#Fitting-of-EPR-Spectra-with-MarS" title="Link to this heading"></a></h1>
<p>This notebook demonstrates how to use the Mars library to fit experimental EPR spectra by optimizing Hamiltonian (or other) parameters.</p>
<p>Mars provides integration with powerful optimization libraries (Optuna and Nevergrad) that implement various algorithms with different strengths for finding global minima in complex parameter spaces.</p>
<div class="line-block">
<div class="line"><br /></div>
<div class="line">For any questions, please contact Arkady Samsonenko via:</div>
<div class="line">Telegram: &#64;Arkady_Samsonenko</div>
<div class="line">Email: a.samsonenko.tomo.nsc.ru</div>
<div class="line">The last notebook update: 2026.01.27</div>
<div class="line">Please, if you want to download this notebook to your computer visit <a class="reference external" href="https://github.com/ArkadySamsonenkoWork/MarS/tree/main/examples">https://github.com/ArkadySamsonenkoWork/MarS/tree/main/examples</a></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import necessary libraries</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.signal</span><span class="w"> </span><span class="kn">import</span> <span class="n">savgol_filter</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">optuna</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">nevergrad</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ng</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">)))</span>
<span class="c1"># Import Mars library components</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">mars</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mars</span><span class="w"> </span><span class="kn">import</span> <span class="n">spin_model</span><span class="p">,</span> <span class="n">spectra_manager</span><span class="p">,</span> <span class="n">mesher</span><span class="p">,</span> <span class="n">constants</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mars</span><span class="w"> </span><span class="kn">import</span> <span class="n">utils</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Some stuff might fail: issue in joblib
</pre></div></div>
</div>
<section id="1.-Introduction-to-EPR-Spectral-Fitting">
<h2>1. Introduction to EPR Spectral Fitting<a class="headerlink" href="#1.-Introduction-to-EPR-Spectral-Fitting" title="Link to this heading"></a></h2>
<p>Fitting EPR spectra involves finding the optimal set of spin Hamiltonian parameters that reproduce experimental data. For complex systems with multiple interacting spins, this becomes a challenging non-linear optimization problem with many parameters.</p>
<p>Mars provides a flexible framework for this task by integrating state-of-the-art optimization algorithms. The workflow involves:</p>
<ol class="arabic simple">
<li><p>Defining a parameterized spin system model</p></li>
<li><p>Creating a parameter space with appropriate bounds</p></li>
<li><p>Setting up an objective function (for example, mean squared error)</p></li>
<li><p>Running optimization with different algorithms</p></li>
<li><p>Analyzing best-fit parameters and spectra</p></li>
</ol>
<p>Key optimization strategies we’ll explore:</p>
<ul class="simple">
<li><p><strong>Tree-structured Parzen Estimator optimization</strong> (via Optuna’s TPE): Good for initial exploration of parameter space.</p></li>
<li><p><strong>Evolutionary strategies</strong> (CMA-ES): Efficient at converging to local minima</p></li>
<li><p><strong>Gradient-free optimization</strong> (Cobyla): Fast convergence when starting near a solution</p></li>
<li><p><strong>Hybrid approaches</strong>: Combining methods for robust fitting</p></li>
</ul>
</section>
</section>
<section id="2.-Generating-Synthetic-Data">
<h1>2. Generating Synthetic Data<a class="headerlink" href="#2.-Generating-Synthetic-Data" title="Link to this heading"></a></h1>
<p>Let’s start by generating two synthetic EPR spectra that we’ll later try to fit.</p>
<p>We create spectra with the same g-tensor parameters and different zero field splitting</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">generate_synthetic_spectrum</span><span class="p">(</span><span class="n">g_tensor_values</span><span class="p">,</span> <span class="n">dipolar_D</span><span class="p">,</span> <span class="n">dipolar_E</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">10.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a synthetic spectrum with specified parameters</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    g_tensor_values : tuple</span>
<span class="sd">        Principal values of the g-tensor (gx, gy, gz)</span>
<span class="sd">    dipolar_D, dipolar_E : float</span>
<span class="sd">        Zero-field splitting parameters D and E (in Hz)</span>
<span class="sd">    temperature : float</span>
<span class="sd">        Temperature in Kelvin (default: 10.0 K)</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    fields : numpy.ndarray</span>
<span class="sd">        Magnetic field values in Tesla</span>
<span class="sd">    spectrum_smooth : numpy.ndarray</span>
<span class="sd">        Simulated spectrum with added noise and smoothing</span>
<span class="sd">    spectrum_clean : numpy.ndarray</span>
<span class="sd">        Simulated spectrum without distortions</span>
<span class="sd">     &quot;&quot;&quot;</span>

    <span class="c1"># Create parameterized spin system</span>
    <span class="n">g_tensor</span> <span class="o">=</span> <span class="n">spin_model</span><span class="o">.</span><span class="n">Interaction</span><span class="p">(</span><span class="n">g_tensor_values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">dipolar_interaction</span> <span class="o">=</span> <span class="n">spin_model</span><span class="o">.</span><span class="n">DEInteraction</span><span class="p">([</span><span class="n">dipolar_D</span><span class="p">,</span> <span class="n">dipolar_E</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="n">system</span> <span class="o">=</span> <span class="n">spin_model</span><span class="o">.</span><span class="n">SpinSystem</span><span class="p">(</span>
        <span class="n">electrons</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>
        <span class="n">g_tensors</span><span class="o">=</span><span class="p">[</span><span class="n">g_tensor</span><span class="p">,</span> <span class="n">g_tensor</span><span class="p">],</span>
        <span class="n">electron_electron</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dipolar_interaction</span><span class="p">)],</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span>
    <span class="p">)</span>

    <span class="n">sample</span> <span class="o">=</span> <span class="n">spin_model</span><span class="o">.</span><span class="n">MultiOrientedSample</span><span class="p">(</span>
        <span class="n">base_spin_system</span><span class="o">=</span><span class="n">system</span><span class="p">,</span>
        <span class="n">ham_strain</span><span class="o">=</span><span class="mf">5e7</span><span class="p">,</span>
        <span class="n">gauss</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
        <span class="n">lorentz</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span>
    <span class="p">)</span>

    <span class="c1"># Create spectra at Q-band frequency</span>
    <span class="n">freq</span> <span class="o">=</span> <span class="mf">34e9</span>  <span class="c1"># 34 GHz</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.12</span><span class="p">,</span> <span class="mf">1.25</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="c1"># Create spectrum</span>
    <span class="n">spectra_creator</span> <span class="o">=</span> <span class="n">spectra_manager</span><span class="o">.</span><span class="n">StationarySpectra</span><span class="p">(</span>
        <span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">,</span>
        <span class="n">sample</span><span class="o">=</span><span class="n">sample</span><span class="p">,</span>
        <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span>
    <span class="p">)</span>

    <span class="n">spectrum</span> <span class="o">=</span> <span class="n">spectra_creator</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>


    <span class="c1"># Apply distrotions to make it more realistic</span>
    <span class="c1"># Noize + smooth + Noize</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.03</span> <span class="o">*</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">size</span><span class="o">=</span><span class="n">spectrum</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">spectrum_noisy</span> <span class="o">=</span> <span class="n">spectrum</span> <span class="o">+</span> <span class="n">noise</span>

    <span class="n">spectrum_smooth</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
        <span class="n">savgol_filter</span><span class="p">(</span><span class="n">spectrum_noisy</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">window_length</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">polyorder</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span>
    <span class="p">)</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.01</span> <span class="o">*</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">size</span><span class="o">=</span><span class="n">spectrum</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">spectrum_smooth</span> <span class="o">=</span> <span class="n">spectrum_smooth</span> <span class="o">+</span> <span class="n">noise</span>


    <span class="k">return</span> <span class="n">fields</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">spectrum_smooth</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>


<span class="c1"># Generate two synthetic spectra with different parameters</span>
<span class="c1"># They have the similar g-tensors but different D-E parameters</span>
<span class="n">fields1</span><span class="p">,</span> <span class="n">spectrum1</span><span class="p">,</span> <span class="n">spectrum_clean1</span> <span class="o">=</span> <span class="n">generate_synthetic_spectrum</span><span class="p">(</span>
    <span class="n">g_tensor_values</span><span class="o">=</span><span class="p">(</span><span class="mf">2.03</span><span class="p">,</span> <span class="mf">2.05</span><span class="p">,</span> <span class="mf">2.08</span><span class="p">),</span>
    <span class="n">dipolar_D</span><span class="o">=</span><span class="mf">100e6</span><span class="p">,</span>  <span class="c1"># 100 MHz</span>
    <span class="n">dipolar_E</span><span class="o">=</span><span class="mf">10e6</span><span class="p">,</span>   <span class="c1"># 10 MHz</span>
    <span class="n">temperature</span><span class="o">=</span><span class="mf">10.0</span>
<span class="p">)</span>

<span class="n">fields2</span><span class="p">,</span> <span class="n">spectrum2</span><span class="p">,</span> <span class="n">spectrum_clean2</span> <span class="o">=</span> <span class="n">generate_synthetic_spectrum</span><span class="p">(</span>
    <span class="n">g_tensor_values</span><span class="o">=</span><span class="p">(</span><span class="mf">2.03</span><span class="p">,</span> <span class="mf">2.05</span><span class="p">,</span> <span class="mf">2.08</span><span class="p">),</span> <span class="c1"># Set the same as previous</span>
    <span class="n">dipolar_D</span><span class="o">=</span><span class="mf">150e6</span><span class="p">,</span>  <span class="c1"># 150 MHz</span>
    <span class="n">dipolar_E</span><span class="o">=</span><span class="mf">25e6</span><span class="p">,</span>   <span class="c1"># 25 MHz</span>
    <span class="n">temperature</span><span class="o">=</span><span class="mf">10.0</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fields1</span><span class="p">,</span> <span class="n">spectrum1</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;experimental&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fields1</span><span class="p">,</span> <span class="n">spectrum_clean1</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;clean specta&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Synthetic EPR Spectrum 1 (D = 100 MHz, E = 10 MHz)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Magnetic Field (T)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Intensity (a.u.)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fields2</span><span class="p">,</span> <span class="n">spectrum2</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;experimental&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fields1</span><span class="p">,</span> <span class="n">spectrum_clean2</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;clean specta&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Synthetic EPR Spectrum 2 (D = 150 MHz, E = 25 MHz)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Magnetic Field (T)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Intensity (a.u.)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_examples_for_documentation_example_3_5_0.png" src="../../_images/examples_examples_for_documentation_example_3_5_0.png" />
</div>
</div>
</section>
<section id="3.-Setting-Up-the-Parameter-Space-for-Optimization">
<h1>3. Setting Up the Parameter Space for Optimization<a class="headerlink" href="#3.-Setting-Up-the-Parameter-Space-for-Optimization" title="Link to this heading"></a></h1>
<p>In this unit we create the optimization space and consider its possibilities</p>
<p>We will define:</p>
<ol class="arabic simple">
<li><p><strong>g-tensor components</strong> (gx, gy, gz):</p></li>
<li><p><strong>Zero-field splitting parameters</strong> (D, E):</p></li>
<li><p><strong>Line broadening parameters</strong>: Hamiltonian strain and Lorentzian width</p></li>
</ol>
<p>For our simple spectra it can be overkill but we want to consider how different methods find results</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">mars.optimization</span><span class="w"> </span><span class="kn">import</span> <span class="n">ParameterSpace</span><span class="p">,</span> <span class="n">ParamSpec</span><span class="p">,</span> <span class="n">SpectrumFitter</span><span class="p">,</span> <span class="n">SpaceSearcher</span><span class="p">,</span> <span class="n">print_trial_results</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[KeOps] Warning : No C++ compiler found. Define CXX environment variable or install g++.
[KeOps] Warning : No C++ compiler found. You need to either define the CXX environment variable pointing to a valid compiler, or ensure that &#39;g++&#39; is installed and in your PATH.
[KeOps] Warning : CUDA libraries not found or could not be loaded; Switching to CPU only.
[KeOps] Warning : No C++ compiler found. You need to either define the CXX environment variable pointing to a valid compiler, or ensure that &#39;g++&#39; is installed and in your PATH.
[KeOps] Warning : No C++ compiler available to check for OpenMP support.
[KeOps] Warning : OpenMP support is not available. Disabling OpenMP.
</pre></div></div>
</div>
<p>Let’s create single parameter to optimize and consider its possible paramerters</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gz</span> <span class="o">=</span> <span class="n">ParamSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;gz&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mf">2.05</span><span class="p">)</span>

<span class="c1"># Sometimes, when it is necessary to evaluate the influence of various parameters, it is advisable to fix this parameter.</span>
<span class="n">gz</span> <span class="o">=</span> <span class="n">ParamSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;gz&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mf">2.05</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># In this case the default value will be used</span>
</pre></div>
</div>
</div>
<p>Here we created one single parameter that will be optimized. It takes:</p>
<ol class="arabic simple">
<li><p>Name</p></li>
<li><p>Bounds of variation</p></li>
<li><p>Default value</p></li>
</ol>
<p>This parameter is part of parameter space. Let’s create this space</p>
<p>Let’s create the parameter space:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">param_specs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># g-tensor components</span>
    <span class="n">ParamSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;gz&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.10</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mf">2.05</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">ParamSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;gx&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.06</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mf">2.05</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">ParamSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;gy&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.06</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mf">2.05</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>

    <span class="c1"># Dipolar coupling parameters</span>
    <span class="n">ParamSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">50e6</span><span class="p">,</span> <span class="mf">200e6</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mf">100e6</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>  <span class="c1"># 50-200 MHz</span>
    <span class="n">ParamSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;E&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">5e6</span><span class="p">,</span> <span class="mf">40e6</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mf">10e6</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>    <span class="c1"># 5-40 MHz</span>

    <span class="c1"># Hamiltonian strain</span>
    <span class="n">ParamSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;ham_strain&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">2e7</span><span class="p">,</span> <span class="mf">1e8</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mf">5e7</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>

    <span class="c1"># Set only Lorentz, since gauss with ham_strain is overfit</span>
    <span class="n">ParamSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;lorentz&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="p">]</span>  <span class="c1"># Create the list of varied parameters</span>


<span class="c1"># Create parameter space with fixed parameters</span>
<span class="n">param_space</span> <span class="o">=</span> <span class="n">ParameterSpace</span><span class="p">(</span>
    <span class="n">specs</span><span class="o">=</span><span class="n">param_specs</span><span class="p">,</span>
    <span class="n">fixed_params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">:</span> <span class="mf">34e9</span><span class="p">}</span>
<span class="p">)</span>  <span class="c1"># parameter space consist of: varing parameters and fixed_parameters</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">param_space</span><span class="p">)</span> <span class="c1"># Display parameter space configuration</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
____Fixed parameters_____
----------------------------------------
  temperature =         10.0000
  freq        =        3.40e+10


______Varying parameters_____
----------------------------------------
  gz         =          2.0500   (low:   +2.0000  up:   +2.1000)
  gx         =          2.0500   (low:   +2.0000  up:   +2.0600)
  gy         =          2.0500   (low:   +2.0000  up:   +2.0600)
  D          =        1.00e+08   (low:   +5.00e+07  up:   +2.00e+08)
  E          =        1.00e+07   (low:   +5.00e+06  up:   +4.00e+07)
  ham_strain =        5.00e+07   (low:   +2.00e+07  up:   +1.00e+08)
  lorentz    =          0.0001   (low:   +0.0000  up:   +0.0010)

</pre></div></div>
</div>
<p>Let’s create function that get’s parameters and returns sample</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">create_sample</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create sample with new parameters&quot;&quot;&quot;</span>
    <span class="c1"># Create g-tensor with given parameters</span>
    <span class="n">g_tensor</span> <span class="o">=</span> <span class="n">spin_model</span><span class="o">.</span><span class="n">Interaction</span><span class="p">(</span>
        <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;gx&quot;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;gy&quot;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;gz&quot;</span><span class="p">]),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span>
    <span class="p">)</span>

    <span class="c1"># Create dipolar interaction</span>
    <span class="n">dipolar_interaction</span> <span class="o">=</span> <span class="n">spin_model</span><span class="o">.</span><span class="n">DEInteraction</span><span class="p">(</span>
        <span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;E&quot;</span><span class="p">]],</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span>
    <span class="p">)</span>

    <span class="c1"># Create spin system</span>
    <span class="n">system</span> <span class="o">=</span> <span class="n">spin_model</span><span class="o">.</span><span class="n">SpinSystem</span><span class="p">(</span>
        <span class="n">electrons</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>
        <span class="n">g_tensors</span><span class="o">=</span><span class="p">[</span><span class="n">g_tensor</span><span class="p">,</span> <span class="n">g_tensor</span><span class="p">],</span>
        <span class="n">electron_electron</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dipolar_interaction</span><span class="p">)],</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span>
    <span class="p">)</span>

    <span class="c1"># Create sample</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">spin_model</span><span class="o">.</span><span class="n">MultiOrientedSample</span><span class="p">(</span>
        <span class="n">base_spin_system</span><span class="o">=</span><span class="n">system</span><span class="p">,</span>
        <span class="n">ham_strain</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;ham_strain&quot;</span><span class="p">],</span>
        <span class="n">lorentz</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;lorentz&quot;</span><span class="p">],</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">sample</span>


<span class="n">sample_default</span> <span class="o">=</span> <span class="n">create_sample</span><span class="p">(</span><span class="n">param_space</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sample_default</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
============================================================
SPIN SYSTEM SUMMARY
============================================================

PARTICLES:
--------------------
Electrons (2):
  e0: S=0.5
Principal values: [2.0500, 2.0500, 2.0500]
      Frame (Euler angles): [α=0.000, β=0.000, γ=0.000] rad
      Strain: None
  e1: S=0.5
Principal values: [2.0500, 2.0500, 2.0500]
      Frame (Euler angles): [α=0.000, β=0.000, γ=0.000] rad
      Strain: None

Nuclei: None

SYSTEM PROPERTIES:
--------------------
Hilbert space dimension: 4
Configuration shape: ()

INTERACTIONS (1 total):
------------------------------

Electron-Electron (1):
  1. e0 ↔ e1:
      Principal values: [-2.33e+07, -4.33e+07, 6.67e+07]
      Frame (Euler angles): [α=0.000, β=0.000, γ=0.000] rad
      Strain: None

============================================================

============================================================
GENERAL INFO:
============================================================
lorentz: 0.00010 T
gauss: 0.00000 T
ham_str: [&#39;5.0000e+07&#39;, &#39;5.0000e+07&#39;, &#39;5.0000e+07&#39;] Hz
</pre></div></div>
</div>
</section>
<section id="4.-Fitting-procedures">
<h1>4. Fitting procedures<a class="headerlink" href="#4.-Fitting-procedures" title="Link to this heading"></a></h1>
<p>We need a callable object that generates spectra based on optimization parameters. This simulator will be used by the optimizer to evaluate different parameter sets. You can create</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CWSpectraSimulator</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span> <span class="c1"># It takes Two parameters: fields and params from param_space</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a spectrum for given magnetic fields and parameters</span>
<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        fields : torch.Tensor</span>
<span class="sd">            Magnetic field values in Tesla</span>
<span class="sd">        params : dict</span>
<span class="sd">            Parameter dictionary from the parameter space</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        spectrum : torch.Tensor</span>
<span class="sd">            Simulated EPR spectrum</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="n">create_sample</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="c1"># Create sample with current parameters</span>

        <span class="n">spectra_creator</span> <span class="o">=</span> <span class="n">spectra_manager</span><span class="o">.</span><span class="n">StationarySpectra</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">],</span> <span class="n">sample</span><span class="o">=</span><span class="n">sample</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="n">spectra_creator</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span> <span class="c1"># Generate and return the spectrum</span>

        <span class="k">return</span> <span class="n">spectrum</span>
</pre></div>
</div>
</div>
<p>Now we create the SpectrumFitter object that will handle the optimization process. By default, it uses Mean Squared Error (MSE) as the objective function, but other metrics like correlation or cosine similarity can also be used.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fitter1</span> <span class="o">=</span> <span class="n">SpectrumFitter</span><span class="p">(</span>
    <span class="n">x_exp</span><span class="o">=</span><span class="n">fields1</span><span class="p">,</span> <span class="c1"># Experimental field values</span>
    <span class="n">y_exp</span><span class="o">=</span><span class="n">spectrum1</span><span class="p">,</span> <span class="c1"># Experimental spectrum intensities</span>
    <span class="n">param_space</span><span class="o">=</span><span class="n">param_space</span><span class="p">,</span> <span class="c1"># Parameter space defined earlier</span>
    <span class="n">spectra_simulator</span><span class="o">=</span><span class="n">CWSpectraSimulator</span><span class="p">(),</span>
    <span class="n">norm_mode</span><span class="o">=</span><span class="s2">&quot;max&quot;</span><span class="p">,</span>  <span class="c1"># Normalize by maximum intensity</span>
    <span class="n">device</span><span class="o">=</span><span class="n">device</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="5.-Fitting-methods">
<h1>5. Fitting methods<a class="headerlink" href="#5.-Fitting-methods" title="Link to this heading"></a></h1>
<p>MarS integrates with two powerful optimization libraries:</p>
<ol class="arabic simple">
<li><p><strong>Optuna [1]</strong>: Optuna has few optimization methods. However, it utilizes some of the most important and interesting ones. It also has its own capabilities for parameter space exploration.</p></li>
</ol>
<p>Tree-structured Parzen Estimator (TPE): Good for global exploration CMA-ES: Efficient evolutionary strategy for local refinement</p>
<p>1.1) Bayseian optimization: This method is very time-consuming, but requires the fewest number of steps. Furthermore, it provides a controlled balance between exploration and exploitation.   If the calculation time for a single spectrum is long (more than 2-10 seconds), it is better to use this method.</p>
<p>1.2) TPE (Tree-structured Parzen Estimator). This method has the powerfull exploration and can be used not only to get the best fit result but also to discover optimization space.</p>
<p>1.3) CmaEs. This is evolution-based stratagy</p>
<p>1.4) Other methods that can be found in docs of Optuna [<a class="reference external" href="https://optuna.readthedocs.io/en/stable/reference/samplers/generated/optuna.samplers.CmaEsSampler.html#optuna.samplers.CmaEsSampler">https://optuna.readthedocs.io/en/stable/reference/samplers/generated/optuna.samplers.CmaEsSampler.html#optuna.samplers.CmaEsSampler</a>]</p>
<ol class="arabic simple" start="2">
<li><p><strong>Nevergrad</strong> [2]. Nevergrad provides 400+ optimization algorithms from various families.</p></li>
</ol>
<p>Today we consider onlly one of them: COBYLA: Constraint Optimization BY Linear Approximations</p>
<p>[1] Akiba et al., “Optuna: A Next-generation Hyperparameter Optimization Framework”, KDD 2019 [2] Rapin &amp; Teytaud, “Nevergrad - A Python toolbox for performing gradient-free optimization”, 2018</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">SpectrumFitter</span><span class="o">.</span><span class="n">__available_optimizer__</span>   <span class="c1"># can print all avaliable optimizaers</span>
</pre></div>
</div>
</div>
<p>We start from TPE (Tree-structured Parzen Estimator). TPE is a Bayesian optimization method that balances exploration and exploitation. It’s particularly useful for initial exploration of complex parameter spaces. It is introducaed via optuna backend.</p>
<p>We’ll also explore using the Optuna dashboard. You can learn more about its capabilities at: <a class="reference external" href="https://optuna-dashboard.readthedocs.io/en/stable/getting-started.html">https://optuna-dashboard.readthedocs.io/en/stable/getting-started.html</a></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result_TPE</span> <span class="o">=</span> <span class="n">fitter1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="s2">&quot;optuna&quot;</span><span class="p">,</span> <span class="n">n_trials</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">run_dashboard</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">study_name</span><span class="o">=</span><span class="s2">&quot;test_study_TPE&quot;</span><span class="p">)</span>
<span class="c1"># Optuna with TPE is default method, We also run dash board to study it</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "c07f686013a84859b027aa8cf668a6d9", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Bottle v0.13.4 server starting up (using WSGIRefServer())...
Listening on http://localhost:8080/
Hit Ctrl-C to quit.

</pre></div></div>
</div>
<p>The Optuna-dashboard is now opened. Just search it yourself; it’s quite intuitive.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fields1</span><span class="p">,</span> <span class="n">spectrum1</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">spectrum1</span><span class="p">),</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;experimental&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fields1</span><span class="p">,</span> <span class="n">result_TPE</span><span class="o">.</span><span class="n">best_spectrum</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">result_TPE</span><span class="o">.</span><span class="n">best_spectrum</span><span class="o">.</span><span class="n">numpy</span><span class="p">()),</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;fitting TPE&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;EPR Spectrum 1&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Magnetic Field (T)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Intensity (a.u.)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x1d9c6ab8a90&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_examples_for_documentation_example_3_25_1.png" src="../../_images/examples_examples_for_documentation_example_3_25_1.png" />
</div>
</div>
<p>The TPE algorithm provides good exploration of the parameter space but may not efficiently converge to the exact minimum. It helps identify promising regions but often requires refinement with other methods.</p>
<p>The full list of Optaina optimizers are given at <a class="reference external" href="https://optuna.readthedocs.io/en/stable/reference/samplers/index.html">https://optuna.readthedocs.io/en/stable/reference/samplers/index.html</a>.</p>
<p>Here we try to use CmaEsSampler. CMA-ES (Covariance Matrix Adaptation Evolution Strategy) is an evolutionary algorithm that efficiently converges to local minima.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sampler</span> <span class="o">=</span> <span class="n">optuna</span><span class="o">.</span><span class="n">samplers</span><span class="o">.</span><span class="n">CmaEsSampler</span><span class="p">(</span>
                <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
                <span class="n">n_startup_trials</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                <span class="n">restart_strategy</span><span class="o">=</span><span class="s2">&quot;ipop&quot;</span><span class="p">)</span>  <span class="c1"># You can define sampler of optuna</span>

<span class="n">result_CmaEs</span> <span class="o">=</span> <span class="n">fitter1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="s2">&quot;optuna&quot;</span><span class="p">,</span> <span class="n">n_trials</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">run_dashboard</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">study_name</span><span class="o">=</span><span class="s2">&quot;test_study_CmaEs&quot;</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span><span class="p">)</span>
<span class="c1"># Optuna with CmaEsSampler is better to find minima than TPE, but it doen&#39;t allow so deep exploaraion as TPE</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
C:\Users\User\AppData\Local\Programs\Python\Python310\lib\site-packages\optuna\samplers\_cmaes.py:270: FutureWarning: `restart_strategy` has been deprecated in v4.4.0. This feature will be removed in v6.0.0. See https://github.com/optuna/optuna/releases/tag/v4.4.0. From v4.4.0 onward, `restart_strategy` automatically falls back to `None`. `restart_strategy` will be supported in OptunaHub.
  optuna_warn(
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "b13e8f624c244ffb849b53b1b479783a", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fields1</span><span class="p">,</span> <span class="n">spectrum1</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">spectrum1</span><span class="p">),</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;experimental&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fields1</span><span class="p">,</span> <span class="n">result_CmaEs</span><span class="o">.</span><span class="n">best_spectrum</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">result_CmaEs</span><span class="o">.</span><span class="n">best_spectrum</span><span class="o">.</span><span class="n">numpy</span><span class="p">()),</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;fitting CmaEs&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;EPR Spectrum 1&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Magnetic Field (T)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Intensity (a.u.)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x1d9d051c1f0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_examples_for_documentation_example_3_29_1.png" src="../../_images/examples_examples_for_documentation_example_3_29_1.png" />
</div>
</div>
<p>CMA-ES typically converges faster to local minima than TPE but may miss global minima if the initial parameter space is too wide.</p>
<p>Now let’s try to use COBYLA fitting method from Nevergrad. COBYLA (Constrained Optimization BY Linear Approximations) is a derivative-free optimization method that’s efficient for local refinement when starting near a solution.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result_Cobyla</span> <span class="o">=</span> <span class="n">fitter1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="s2">&quot;ng&quot;</span><span class="p">,</span> <span class="n">budget</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">optimizer_name</span><span class="o">=</span><span class="s2">&quot;Cobyla&quot;</span><span class="p">)</span>  <span class="c1"># Note, Nevergrad and Optuna naming is different. Be careful with it</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fields1</span><span class="p">,</span> <span class="n">spectrum1</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">spectrum1</span><span class="p">),</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;experimental&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fields1</span><span class="p">,</span> <span class="n">result_Cobyla</span><span class="o">.</span><span class="n">best_spectrum</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">result_Cobyla</span><span class="o">.</span><span class="n">best_spectrum</span><span class="o">.</span><span class="n">numpy</span><span class="p">()),</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;fitting Cobyla&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;EPR Spectrum 1&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Magnetic Field (T)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Intensity (a.u.)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x1d9d1da1f60&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_examples_for_documentation_example_3_33_1.png" src="../../_images/examples_examples_for_documentation_example_3_33_1.png" />
</div>
</div>
<p>COBYLA works well when starting near a solution but can struggle with global optimization. It’s best used after initial exploration with methods like TPE.</p>
<p>The good solution is combining different methods to find the best result.</p>
<p><strong>Let’s try to do next steps:</strong></p>
<ol class="arabic simple">
<li><p>Use TPE for initial global exploration</p></li>
<li><p>Refine the parameter space bounds based on promising regions</p></li>
<li><p>Use CMA-ES or COBYLA for fast local convergence</p></li>
</ol>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run TPE again</span>
<span class="n">result_TPE</span> <span class="o">=</span> <span class="n">fitter1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="s2">&quot;optuna&quot;</span><span class="p">,</span> <span class="n">n_trials</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">run_dashboard</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">study_name</span><span class="o">=</span><span class="s2">&quot;test_study_TPE&quot;</span><span class="p">)</span>
<span class="n">best_params_TPE</span> <span class="o">=</span> <span class="n">result_TPE</span><span class="o">.</span><span class="n">best_params</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
C:\Users\User\AppData\Local\Programs\Python\Python310\lib\site-packages\optuna\_experimental.py:33: ExperimentalWarning: Argument ``multivariate`` is an experimental feature. The interface can change in the future.
  optuna_warn(
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "ab133d25cec8463cae0587ca540270d0", "version_major": 2, "version_minor": 0}</script></div>
</div>
<p>We then consider what we can do with our current results and update the parameter space.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">updated_param_space</span> <span class="o">=</span> <span class="n">param_space</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">updated_param_space</span><span class="o">.</span><span class="n">set_bounds</span><span class="p">({</span><span class="s2">&quot;gx&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.1</span><span class="p">)})</span>  <span class="c1"># We can set new bounds</span>
<span class="n">updated_param_space</span><span class="o">.</span><span class="n">set_default</span><span class="p">(</span><span class="n">best_params_TPE</span><span class="p">)</span>  <span class="c1"># Update default values to the best parameters found by TPE</span>
<span class="n">updated_param_space</span><span class="o">.</span><span class="n">reduce_bounds</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span> <span class="c1"># Reduce bounds to focus on promising region (50% of original width)</span>


<span class="c1"># Let&#39;s observe how the parameter space has changed</span>
<span class="n">fitter1</span><span class="o">.</span><span class="n">param_space</span> <span class="o">=</span> <span class="n">updated_param_space</span>
<span class="n">fitter1</span><span class="o">.</span><span class="n">param_space</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
____Fixed parameters_____
----------------------------------------
  temperature =         10.0000
  freq        =        3.40e+10


______Varying parameters_____
----------------------------------------
  gz         =          2.0793   (low:   +2.0293  up:   +2.1293)
  gx         =          2.0309   (low:   +1.9809  up:   +2.0809)
  gy         =          2.0495   (low:   +2.0195  up:   +2.0795)
  D          =        1.35e+08   (low:   +6.05e+07  up:   +2.10e+08)
  E          =        2.09e+07   (low:   +3.45e+06  up:   +3.84e+07)
  ham_strain =        7.41e+07   (low:   +3.41e+07  up:   +1.14e+08)
  lorentz    =          0.0006   (low:   +0.0001  up:   +0.0011)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result_continue</span> <span class="o">=</span> <span class="n">fitter1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="s2">&quot;ng&quot;</span><span class="p">,</span> <span class="n">budget</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">optimizer_name</span><span class="o">=</span><span class="s2">&quot;Cobyla&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fields1</span><span class="p">,</span> <span class="n">spectrum1</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">spectrum1</span><span class="p">),</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;experimental&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fields1</span><span class="p">,</span> <span class="n">result_continue</span><span class="o">.</span><span class="n">best_spectrum</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">result_continue</span><span class="o">.</span><span class="n">best_spectrum</span><span class="o">.</span><span class="n">numpy</span><span class="p">()),</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;fitting several optimizers&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;EPR Spectrum 1&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Magnetic Field (T)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Intensity (a.u.)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x1d9d25712d0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_examples_for_documentation_example_3_40_1.png" src="../../_images/examples_examples_for_documentation_example_3_40_1.png" />
</div>
</div>
<p>Probably, it is the best result. The hybrid approach typically yields the best results by combining global exploration with local refinement.</p>
<p>Sometimes multiple local minima exist in complex optimization problems. Mars provides tools to identify alternative solutions that might be physically meaningful.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run TPE again</span>
<span class="n">fitter1</span><span class="o">.</span><span class="n">param_space</span> <span class="o">=</span> <span class="n">param_space</span>
<span class="n">result_TPE</span><span class="o">=</span> <span class="n">fitter1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="s2">&quot;optuna&quot;</span><span class="p">,</span> <span class="n">n_trials</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">run_dashboard</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">study_name</span><span class="o">=</span><span class="s2">&quot;test_study_TPE&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
C:\Users\User\AppData\Local\Programs\Python\Python310\lib\site-packages\optuna\_experimental.py:33: ExperimentalWarning: Argument ``multivariate`` is an experimental feature. The interface can change in the future.
  optuna_warn(
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "6faa6e1a9f04486fb3f8f45aff3b72bc", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">searcher</span> <span class="o">=</span> <span class="n">SpaceSearcher</span><span class="p">()</span>  <span class="c1"># Here we create a new instance-Space Searcher. It has some capabilities for searching for other local minima, if they exist.</span>
</pre></div>
</div>
</div>
<p>The space searcher identifies alternative parameter sets with similar loss values but different parameter combinations. This is particularly useful when certain parameters (like g-tensor components) are correlated or when multiple physically meaningful solutions exist.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">searche_results</span> <span class="o">=</span> <span class="n">searcher</span><span class="p">(</span><span class="n">fit_result</span><span class="o">=</span><span class="n">result_CmaEs</span><span class="p">,</span> <span class="n">param_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;gx&quot;</span><span class="p">,</span> <span class="s2">&quot;gy&quot;</span><span class="p">,</span> <span class="s2">&quot;gz&quot;</span><span class="p">])</span>

<span class="c1"># set param_names which defines subspace in which new solutions should be found</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_trial_results</span><span class="p">(</span><span class="n">searche_results</span><span class="p">)</span>  <span class="c1"># print_trial_results allows to print the parameters in convinient way.</span>

<span class="c1">#1) Loss means the same as for optimization.</span>
<span class="c1">#2) Distance is the distance between the best-fit parameters and the given parameters. This distance is calculated only for param_names.</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
TRIAL #276
index: 0
----------------------------------------
Loss:     0.059717
Distance: 0.105508

PARAMETERS:
----------------------------------------
  gz         =        2.082519 (Δ +0.001861)
  gx         =        2.030069 (Δ +0.000331)
  gy         =        2.049413 (Δ +0.000128)
  D          =      1.1338e+08 (Δ +3.0695e+07)
  E          =      2.0834e+07 (Δ -3.0108e+06)
  ham_strain =      8.6407e+07 (Δ +3.8270e+06)
  lorentz    =        0.000563 (Δ -0.000028)
</pre></div></div>
</div>
<p>Δ shows the change of parameter compared to the best parameter</p>
<p>As it is expected the results are not stable relative to g-tensor parameters which you also observed in dashboard</p>
</section>
<section id="6.-Multi-Spectra-Fitting">
<h1>6. Multi Spectra Fitting<a class="headerlink" href="#6.-Multi-Spectra-Fitting" title="Link to this heading"></a></h1>
<p>MarS allows to find parameters for set of spectra fitting them simultaniously. Let’s do it.</p>
<p>We already have two spectra with identical g-tensors and different zero-field splitting parameters. Let’s determine the parameter sapce for fitting them.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">param_specs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># Shared g-tensor components</span>
    <span class="n">ParamSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;gz&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.10</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mf">2.05</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">ParamSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;gx&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.06</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mf">2.05</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">ParamSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;gy&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.06</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mf">2.05</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>

    <span class="c1"># Dipolar coupling parameters fot first spectra</span>
    <span class="n">ParamSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;D1&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">50e6</span><span class="p">,</span> <span class="mf">250e6</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mf">100e6</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>  <span class="c1"># 50-250 MHz</span>
    <span class="n">ParamSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;E1&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">5e6</span><span class="p">,</span> <span class="mf">50e6</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mf">10e6</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>    <span class="c1"># 5-50 MHz</span>

    <span class="c1"># Dipolar coupling parameters fot the second spectra</span>
    <span class="n">ParamSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;D2&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">50e6</span><span class="p">,</span> <span class="mf">250e6</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mf">100e6</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>  <span class="c1"># 50-250 MHz</span>
    <span class="n">ParamSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;E2&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">5e6</span><span class="p">,</span> <span class="mf">50e6</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mf">10e6</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>    <span class="c1"># 5-50 MHz</span>

    <span class="c1"># Hamiltonian strain are the same for simplification</span>
    <span class="n">ParamSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;ham_strain&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">1e7</span><span class="p">,</span> <span class="mf">1e8</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mf">5e7</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>

    <span class="c1"># Set only lorentz, gauss is overfit</span>
    <span class="n">ParamSpec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;lorentz&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="p">]</span>  <span class="c1"># Create the list of varied parameters</span>

<span class="n">param_space</span> <span class="o">=</span> <span class="n">ParameterSpace</span><span class="p">(</span>
    <span class="n">specs</span><span class="o">=</span><span class="n">param_specs</span><span class="p">,</span>
    <span class="n">fixed_params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">:</span> <span class="mf">34e9</span><span class="p">}</span>
<span class="p">)</span>  <span class="c1"># parameter space consist of: varing parameters and fixed_parameters</span>


<span class="k">def</span><span class="w"> </span><span class="nf">create_two_samples</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="n">sample_params_0</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">sample_params_0</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">],</span> <span class="n">sample_params_0</span><span class="p">[</span><span class="s2">&quot;E&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;D1&quot;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;E1&quot;</span><span class="p">]</span>
    <span class="n">sample_0</span> <span class="o">=</span> <span class="n">create_sample</span><span class="p">(</span><span class="n">sample_params_0</span><span class="p">)</span>

    <span class="n">sample_params_1</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">sample_params_1</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">],</span> <span class="n">sample_params_1</span><span class="p">[</span><span class="s2">&quot;E&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;D2&quot;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;E2&quot;</span><span class="p">]</span>
    <span class="n">sample_1</span> <span class="o">=</span> <span class="n">create_sample</span><span class="p">(</span><span class="n">sample_params_1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sample_0</span><span class="p">,</span> <span class="n">sample_1</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CWSpectraSimulatorMulti</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        fields : list of torch.Tensor</span>
<span class="sd">            List of magnetic field values for each spectrum</span>
<span class="sd">        params : dict</span>
<span class="sd">            Parameter dictionary from the parameter space</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        spectra : list of torch.Tensor</span>
<span class="sd">            List of simulated EPR spectra</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sample_0</span><span class="p">,</span> <span class="n">sample_1</span> <span class="o">=</span> <span class="n">create_two_samples</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

        <span class="n">spectra_creator</span> <span class="o">=</span> <span class="n">spectra_manager</span><span class="o">.</span><span class="n">StationarySpectra</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">],</span> <span class="n">sample</span><span class="o">=</span><span class="n">sample_0</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">spectrum_0</span> <span class="o">=</span> <span class="n">spectra_creator</span><span class="p">(</span><span class="n">sample_0</span><span class="p">,</span> <span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">spectrum_1</span> <span class="o">=</span> <span class="n">spectra_creator</span><span class="p">(</span><span class="n">sample_1</span><span class="p">,</span> <span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">spectrum_0</span><span class="p">,</span> <span class="n">spectrum_1</span><span class="p">]</span>  <span class="c1"># return two spectrum</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fitter_tot</span> <span class="o">=</span> <span class="n">SpectrumFitter</span><span class="p">(</span>
    <span class="n">x_exp</span><span class="o">=</span><span class="p">[</span><span class="n">fields1</span><span class="p">,</span> <span class="n">fields2</span><span class="p">],</span>
    <span class="n">y_exp</span><span class="o">=</span><span class="p">[</span><span class="n">spectrum1</span><span class="p">,</span> <span class="n">spectrum2</span><span class="p">],</span>
    <span class="n">param_space</span><span class="o">=</span><span class="n">param_space</span><span class="p">,</span>
    <span class="n">spectra_simulator</span><span class="o">=</span><span class="n">CWSpectraSimulatorMulti</span><span class="p">(),</span>
    <span class="n">norm_mode</span><span class="o">=</span><span class="s2">&quot;max&quot;</span><span class="p">,</span>  <span class="c1"># Normalize by maximum intensity</span>
    <span class="n">device</span><span class="o">=</span><span class="n">device</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result_Cobyla_tot</span> <span class="o">=</span> <span class="n">fitter_tot</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="s2">&quot;ng&quot;</span><span class="p">,</span> <span class="n">budget</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">optimizer_name</span><span class="o">=</span><span class="s2">&quot;Cobyla&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|████████████████████████████████████████████████████████████████████████████████| 300/300 [00:23&lt;00:00, 12.97it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Step 300: Loss = 0.047811
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">D1</span><span class="p">,</span> <span class="n">E1</span> <span class="o">=</span> <span class="n">result_Cobyla_tot</span><span class="o">.</span><span class="n">best_params</span><span class="p">[</span><span class="s2">&quot;D1&quot;</span><span class="p">],</span> <span class="n">result_Cobyla_tot</span><span class="o">.</span><span class="n">best_params</span><span class="p">[</span><span class="s2">&quot;E1&quot;</span><span class="p">]</span>
<span class="n">D2</span><span class="p">,</span> <span class="n">E2</span> <span class="o">=</span> <span class="n">result_Cobyla_tot</span><span class="o">.</span><span class="n">best_params</span><span class="p">[</span><span class="s2">&quot;D2&quot;</span><span class="p">],</span> <span class="n">result_Cobyla_tot</span><span class="o">.</span><span class="n">best_params</span><span class="p">[</span><span class="s2">&quot;E2&quot;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best parameters for spectrum 1: D1 = </span><span class="si">{</span><span class="n">D1</span><span class="o">/</span><span class="mf">1e6</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MHz, E1 = </span><span class="si">{</span><span class="n">E1</span><span class="o">/</span><span class="mf">1e6</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MHz&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best parameters for spectrum 2: D2 = </span><span class="si">{</span><span class="n">D2</span><span class="o">/</span><span class="mf">1e6</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MHz, E2 = </span><span class="si">{</span><span class="n">E2</span><span class="o">/</span><span class="mf">1e6</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MHz&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;True values: Spectrum 1: D=100 MHz, E=10 MHz | Spectrum 2: D=150 MHz, E=25 MHz&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Best parameters for spectrum 1: D1 = 110.90 MHz, E1 = 32.83 MHz
Best parameters for spectrum 2: D2 = 168.88 MHz, E2 = 32.84 MHz
True values: Spectrum 1: D=100 MHz, E=10 MHz | Spectrum 2: D=150 MHz, E=25 MHz
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">best_spectrum_0</span> <span class="o">=</span> <span class="n">result_Cobyla_tot</span><span class="o">.</span><span class="n">best_spectrum</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">best_spectrum_0</span> <span class="o">=</span> <span class="n">best_spectrum_0</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">best_spectrum_0</span><span class="p">)</span>

<span class="n">best_spectrum_1</span> <span class="o">=</span> <span class="n">result_Cobyla_tot</span><span class="o">.</span><span class="n">best_spectrum</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">best_spectrum_1</span> <span class="o">=</span> <span class="n">best_spectrum_1</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">best_spectrum_1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fields1</span><span class="p">,</span> <span class="n">spectrum1</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">spectrum1</span><span class="p">),</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;experimental&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fields1</span><span class="p">,</span> <span class="n">best_spectrum_0</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;fitting multispectra&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;EPR Spectrum 1&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Magnetic Field (T)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Intensity (a.u.)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fields2</span><span class="p">,</span> <span class="n">spectrum2</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">spectrum2</span><span class="p">),</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;experimental&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fields2</span><span class="p">,</span> <span class="n">best_spectrum_1</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;fitting multispectra&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;EPR Spectrum 2&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Magnetic Field (T)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Intensity (a.u.)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_examples_for_documentation_example_3_55_0.png" src="../../_images/examples_examples_for_documentation_example_3_55_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../example_3.html" class="btn btn-neutral float-left" title="Fitting Procedures" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../example_4.html" class="btn btn-neutral float-right" title="Advance Fitting Procedures" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2026, Arkady Samsonenko, Ivan Kurgansky.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>