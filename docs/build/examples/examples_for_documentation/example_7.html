

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fitting of TimeResolved EPR Spectra with MarS &mdash; MarS 2026.01.11 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css?v=2aa19091" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=7e9183e1"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="prev" title="Time-Resolved Fitting Procedures" href="../example_7.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            MarS
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quick Start</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contents/base_spin_system.html">Base Spin System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contents/sample.html">Sample Representation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contents/spectrum_constraction.html">EPR Spectrum Construction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contents/fitting_tutorial.html">Fitting Spectroscopic Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contents/interactions/index.html">Interactions in MarS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contents/populators/index.html">Population Computation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contents/context/index.html">Relaxation Context</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contents/spectra_creators/index.html">Spectra Creators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contents/intensity_calculators/index.html">Transition Intensity Calculation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contents/meshers/index.html">Meshing Strategies</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/mars.html">mars package</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorial Examples</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../example_1.html">Continuous-Wave EPR Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../example_2.html">Polarized Radiation EPR Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../example_3.html">Fitting Procedures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../example_4.html">Advance Fitting Procedures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../example_5.html">Spectra Polarization and Time Resolved</a></li>
<li class="toctree-l1"><a class="reference internal" href="../example_6.html">Multi-System Kinetic</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../example_7.html">Time-Resolved Fitting Procedures</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Fitting of TimeResolved EPR Spectra with MarS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#1.-Introduction.">1. Introduction.</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#1.1.-Setting-the-Sample-Parameters">1.1. Setting the Sample Parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#1.2.-Relaxation-Context-for-Time-Resolved-Simulation">1.2. Relaxation Context for Time-Resolved Simulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#1.3.-Simulate-Stationary-Spectrum">1.3. Simulate Stationary Spectrum</a></li>
<li class="toctree-l3"><a class="reference internal" href="#1.4.-Syntetic-Spectra-Creation">1.4. Syntetic Spectra Creation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#2.-Fitting-Time-Resolved-Spectra">2. Fitting Time-Resolved Spectra</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#2.1.-Define-Parameter-Space-for-Fitting">2.1. Define Parameter Space for Fitting</a></li>
<li class="toctree-l3"><a class="reference internal" href="#2.2.-Create-Time-Resolved-Spectra-Simulator">2.2. Create Time-Resolved Spectra Simulator</a></li>
<li class="toctree-l3"><a class="reference internal" href="#2.3.-Initialize-the-2D-Spectrum-Fitter">2.3. Initialize the 2D Spectrum Fitter</a></li>
<li class="toctree-l3"><a class="reference internal" href="#2.4.-Fitting-with-Optuna_integration">2.4. Fitting with Optuna_integration</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Project Info</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/ArkadySamsonenkoWork/MarS.git"> GitHub Repository</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">MarS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../example_7.html">Time-Resolved Fitting Procedures</a></li>
      <li class="breadcrumb-item active">Fitting of TimeResolved EPR Spectra with MarS</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/examples/examples_for_documentation/example_7.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Fitting-of-TimeResolved-EPR-Spectra-with-MarS">
<h1>Fitting of TimeResolved EPR Spectra with MarS<a class="headerlink" href="#Fitting-of-TimeResolved-EPR-Spectra-with-MarS" title="Link to this heading"></a></h1>
<p>This notebook demonstrates how to use the Mars library to fit experimental 2d-timeresolved EPR spectra by optimizing Kynetic parameters.</p>
<p>Mars provides integration with powerful optimization libraries (Optuna and Nevergrad) that implement various algorithms with different strengths for finding global minima in complex parameter spaces. In this notebook we will fit 2D-timeresolved spectra via MarS library. We strongly recommend you to consider Example 1 and 5 (and 3, probably) before consideration of this notebook</p>
<div class="line-block">
<div class="line"><br /></div>
<div class="line">For any questions, please contact Arkady Samsonenko via:</div>
<div class="line">Telegram: &#64;Arkady_Samsonenko</div>
<div class="line">Email: a.samsonenko.tomo.nsc.ru</div>
<div class="line">Last update of notebook: 2026.01.27</div>
<div class="line">Please, if you want to download this notebook to your computer visit <a class="reference external" href="https://github.com/ArkadySamsonenkoWork/MarS/tree/main/examples">https://github.com/ArkadySamsonenkoWork/MarS/tree/main/examples</a></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tp</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">)))</span>

<span class="c1"># Import Mars library components</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">mars</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mars</span><span class="w"> </span><span class="kn">import</span> <span class="n">spin_model</span><span class="p">,</span> <span class="n">spectra_manager</span><span class="p">,</span> <span class="n">mesher</span><span class="p">,</span> <span class="n">constants</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mars</span><span class="w"> </span><span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mars</span><span class="w"> </span><span class="kn">import</span> <span class="n">population</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">mars</span><span class="w"> </span><span class="kn">import</span> <span class="n">visualization</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="1.-Introduction.">
<h1>1. Introduction.<a class="headerlink" href="#1.-Introduction." title="Link to this heading"></a></h1>
<p>In this notebook, we focus on a system of three photo-generated triplet states coupled via weak dipolar interactions and exchange interactions, where each triplet may be oriented differently in space.</p>
<p><strong>Workflow:</strong></p>
<ol class="arabic simple">
<li><p>Set the Hamiltonian parameters for each triplet state</p></li>
<li><p>Set the relaxation and population parameters for each system</p></li>
<li><p>Create a time-resolved fitting pipeline</p></li>
</ol>
<section id="1.1.-Setting-the-Sample-Parameters">
<h2>1.1. Setting the Sample Parameters<a class="headerlink" href="#1.1.-Setting-the-Sample-Parameters" title="Link to this heading"></a></h2>
<p>We consider three triplet states (S = 1), each with its own g-tensor and zero-field splitting (ZFS) parameters. We set the same principal values but different orientations for these triplets. The triplets are coupled by weak intermolecular dipolar and exchange interactions.</p>
<p>In our consideration, the second triplet is rotated relative to the first by a fixed Euler angle set, and the third is rotated relative to the second by the same fixed Euler angle set. We call these triplets “a”, “b”, and “c”.</p>
<div class="line-block">
<div class="line"><strong>Note on Model Limitations</strong></div>
<div class="line">The current model only includes the triplet sublevels and neglects the singlet states that are inherently part of real photoexcited systems. A fully consistent description would require treating each chromophore as a singlet–triplet system, i.e., a two-state manifold comprising one singlet (<span class="math notranslate nohighlight">\(|S\rangle\)</span>) and three triplet (<span class="math notranslate nohighlight">\(|T\rangle\)</span>) sublevels.</div>
</div>
<p>If the Hilbert space for a single unit is <span class="math notranslate nohighlight">\(|S\rangle \oplus |T\rangle\)</span>, then the total Hilbert space for three coupled units becomes the tensor product:</p>
<div class="math notranslate nohighlight">
\[(|S_1\rangle \oplus |T_1\rangle) \otimes (|S_2\rangle \oplus |T_2\rangle) \otimes (|S_3\rangle \oplus |T_3\rangle)\]</div>
<p>Expanding the tensor product explicitly gives all eight possible combinations:</p>
<div class="math notranslate nohighlight">
\[\begin{split}|S_1\rangle \otimes |S_2\rangle \otimes |S_3\rangle \\
+ |S_1\rangle \otimes |S_2\rangle \otimes |T_3\rangle \\
+ |S_1\rangle \otimes |T_2\rangle \otimes |S_3\rangle \\
+ |S_1\rangle \otimes |T_2\rangle \otimes |T_3\rangle \\
+ |T_1\rangle \otimes |S_2\rangle \otimes |S_3\rangle \\
+ |T_1\rangle \otimes |S_2\rangle \otimes |T_3\rangle \\
+ |T_1\rangle \otimes |T_2\rangle \otimes |S_3\rangle \\
+ |T_1\rangle \otimes |T_2\rangle \otimes |T_3\rangle\end{split}\]</div>
<p>In compact notation (omitting <span class="math notranslate nohighlight">\(\otimes\)</span> for brevity, as is conventional):</p>
<div class="math notranslate nohighlight">
\[|S_1 S_2 S_3\rangle  \oplus  |S_1 S_2 T_3\rangle  \oplus  |S_1 T_2 S_3\rangle  \oplus  |S_1 T_2 T_3\rangle \oplus  |T_1 S_2 S_3\rangle  \oplus  |T_1 S_2 T_3\rangle  \oplus |T_1 T_2 S_3\rangle  \oplus |T_1 T_2 T_3\rangle\]</div>
<p>In our current consideration we want to discuss the fitting detail rather then physical models. So&lt; futher we will continue the relaxation only the last <span class="math notranslate nohighlight">\(|T_1 T_2 T_3\rangle\)</span> states.</p>
<p>Probably, with manual actions the consideration of full system with 64 is still possible (like notification that Hamiltonian can be created as block-diagonal) but it is already the different task</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">create_triplet_sample</span><span class="p">(</span>
    <span class="n">hamiltonian_params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">tp</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span>
    <span class="n">frame</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">spin_model</span><span class="o">.</span><span class="n">MultiOrientedSample</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct a powder sample containing a single S=1 triplet state.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hamiltonian_params : dict</span>
<span class="sd">        Contains keys: &#39;g&#39; (g-tensor principal values),</span>
<span class="sd">                       &#39;DE&#39; (ZFS D and E parameters in Hz),</span>
<span class="sd">                       &#39;gauss&#39;, &#39;lorentz&#39; (line broadening in Tesla).</span>
<span class="sd">    frame : list[float]</span>
<span class="sd">        Euler angles (α, β, γ) in radians defining the orientation</span>
<span class="sd">        of the molecular frame relative to the lab frame.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    MultiOrientedSample</span>
<span class="sd">        A disordered (powder) sample ready for simulation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">g_tensor</span> <span class="o">=</span> <span class="n">spin_model</span><span class="o">.</span><span class="n">Interaction</span><span class="p">(</span><span class="n">ham_params</span><span class="p">[</span><span class="s2">&quot;g&quot;</span><span class="p">],</span> <span class="n">frame</span><span class="o">=</span><span class="n">frame</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">zfs_interaction</span> <span class="o">=</span> <span class="n">spin_model</span><span class="o">.</span><span class="n">DEInteraction</span><span class="p">(</span><span class="n">ham_params</span><span class="p">[</span><span class="s2">&quot;DE&quot;</span><span class="p">],</span> <span class="n">frame</span><span class="o">=</span><span class="n">frame</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="n">base_spin_system</span> <span class="o">=</span> <span class="n">spin_model</span><span class="o">.</span><span class="n">SpinSystem</span><span class="p">(</span>
        <span class="n">electrons</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">],</span>  <span class="c1"># S=1</span>
        <span class="n">g_tensors</span><span class="o">=</span><span class="p">[</span><span class="n">g_tensor</span><span class="p">],</span>
        <span class="n">electron_electron</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">zfs_interaction</span><span class="p">)],</span> <span class="c1"># ZFS on electron 0</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span>
    <span class="p">)</span>

    <span class="n">sample</span> <span class="o">=</span> <span class="n">spin_model</span><span class="o">.</span><span class="n">MultiOrientedSample</span><span class="p">(</span>
        <span class="n">base_spin_system</span><span class="o">=</span><span class="n">base_spin_system</span><span class="p">,</span>
        <span class="n">gauss</span><span class="o">=</span><span class="n">ham_params</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">],</span>
        <span class="n">lorentz</span><span class="o">=</span><span class="n">ham_params</span><span class="p">[</span><span class="s2">&quot;lorentz&quot;</span><span class="p">],</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>  <span class="c1"># Let&#39;s reduce mesh a little bit. These values will be enough</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">sample</span>
</pre></div>
</div>
</div>
<p><strong>Alternative approach:</strong> It is also possible to achieve the same result by using the <code class="docutils literal notranslate"><span class="pre">spin_system_frame</span></code> parameter of <code class="docutils literal notranslate"><span class="pre">MultiOrientedSample</span></code> or the <code class="docutils literal notranslate"><span class="pre">apply_rotation</span></code> method of <code class="docutils literal notranslate"><span class="pre">SpinSystem</span></code>. See the commented code below for an example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">create_triplet_sample_alternative</span><span class="p">(</span><span class="n">ham_params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">tp</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span> <span class="n">frame</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]):</span>
    <span class="n">g_interaction</span> <span class="o">=</span> <span class="n">spin_model</span><span class="o">.</span><span class="n">Interaction</span><span class="p">(</span><span class="n">ham_params</span><span class="p">[</span><span class="s2">&quot;g&quot;</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>  <span class="c1"># No frames here</span>
    <span class="n">zfs_interaction</span> <span class="o">=</span> <span class="n">spin_model</span><span class="o">.</span><span class="n">DEInteraction</span><span class="p">(</span><span class="n">ham_params</span><span class="p">[</span><span class="s2">&quot;DE&quot;</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>  <span class="c1"># No frames here</span>

    <span class="n">base_spin_system</span> <span class="o">=</span> <span class="n">spin_model</span><span class="o">.</span><span class="n">SpinSystem</span><span class="p">(</span>
        <span class="n">electrons</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">],</span>
        <span class="n">g_tensors</span><span class="o">=</span><span class="p">[</span><span class="n">g_interaction</span><span class="p">],</span>
        <span class="n">electron_electron</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">zfs_interaction</span><span class="p">)],</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span>
    <span class="p">)</span>

    <span class="n">sample</span> <span class="o">=</span> <span class="n">spin_model</span><span class="o">.</span><span class="n">MultiOrientedSample</span><span class="p">(</span>
        <span class="n">base_spin_system</span><span class="o">=</span><span class="n">base_spin_system</span><span class="p">,</span>
        <span class="n">gauss</span><span class="o">=</span><span class="n">ham_params</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">],</span>
        <span class="n">lorentz</span><span class="o">=</span><span class="n">ham_params</span><span class="p">[</span><span class="s2">&quot;lorentz&quot;</span><span class="p">],</span>
        <span class="n">spin_system_frame</span><span class="o">=</span><span class="n">frame</span><span class="p">,</span>  <span class="c1"># Set the relative frame of the whole spin system</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">sample</span>
</pre></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">create_coupled_triplets_sample</span><span class="p">(</span>
    <span class="n">hamiltonian_params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">tp</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span>
    <span class="n">relative_euler_angles_b</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="n">relative_euler_angles_c</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">spin_model</span><span class="o">.</span><span class="n">MultiOrientedSample</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct a sample with two S=1 triplets coupled by a dipolar interaction.</span>
<span class="sd">    The second triplet is rotated by `relative_rotation` relative to the first.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hamiltonian_params : dict</span>
<span class="sd">        Must include: &#39;g&#39;, &#39;DE&#39;, &#39;dipolar&#39; (D, E for inter-triplet coupling),</span>
<span class="sd">                      &#39;gauss&#39;, &#39;lorentz&#39;.</span>
<span class="sd">    relative_euler_angles_b : list[float]</span>
<span class="sd">        Euler angles for rotating the second triplet local frame.</span>

<span class="sd">    relative_euler_angles_c : list[float]</span>
<span class="sd">        Euler angles for rotating the third triplet local frame.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    MultiOrientedSample</span>
<span class="sd">        Powder sample of two interacting triplets.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># First triplet: aligned with frame of molecule (no rotation)</span>
    <span class="n">g_tensor_1</span> <span class="o">=</span> <span class="n">spin_model</span><span class="o">.</span><span class="n">Interaction</span><span class="p">(</span><span class="n">ham_params</span><span class="p">[</span><span class="s2">&quot;g&quot;</span><span class="p">],</span> <span class="n">frame</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">zfs_interaction_1</span> <span class="o">=</span> <span class="n">spin_model</span><span class="o">.</span><span class="n">DEInteraction</span><span class="p">(</span><span class="n">ham_params</span><span class="p">[</span><span class="s2">&quot;DE&quot;</span><span class="p">],</span> <span class="n">frame</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="c1"># Second triplet: rotated</span>
    <span class="n">g_tensor_2</span> <span class="o">=</span> <span class="n">spin_model</span><span class="o">.</span><span class="n">Interaction</span><span class="p">(</span><span class="n">ham_params</span><span class="p">[</span><span class="s2">&quot;g&quot;</span><span class="p">],</span> <span class="n">frame</span><span class="o">=</span><span class="n">relative_euler_angles_b</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">zfs_interaction_2</span> <span class="o">=</span> <span class="n">spin_model</span><span class="o">.</span><span class="n">DEInteraction</span><span class="p">(</span><span class="n">ham_params</span><span class="p">[</span><span class="s2">&quot;DE&quot;</span><span class="p">],</span> <span class="n">frame</span><span class="o">=</span><span class="n">relative_euler_angles_b</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>


    <span class="c1"># Third triplet: rotated twice</span>
    <span class="n">g_tensor_3</span> <span class="o">=</span> <span class="n">spin_model</span><span class="o">.</span><span class="n">Interaction</span><span class="p">(</span><span class="n">ham_params</span><span class="p">[</span><span class="s2">&quot;g&quot;</span><span class="p">],</span> <span class="n">frame</span><span class="o">=</span><span class="n">relative_euler_angles_c</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">zfs_interaction_3</span> <span class="o">=</span> <span class="n">spin_model</span><span class="o">.</span><span class="n">DEInteraction</span><span class="p">(</span><span class="n">ham_params</span><span class="p">[</span><span class="s2">&quot;DE&quot;</span><span class="p">],</span> <span class="n">frame</span><span class="o">=</span><span class="n">relative_euler_angles_c</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>


    <span class="c1"># Dipolar and exchagne coupling between the a and b triplets</span>
    <span class="n">diploar_ab</span> <span class="o">=</span> <span class="n">spin_model</span><span class="o">.</span><span class="n">DEInteraction</span><span class="p">(</span><span class="n">ham_params</span><span class="p">[</span><span class="s2">&quot;dipolar&quot;</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">exchange_ab</span> <span class="o">=</span> <span class="n">spin_model</span><span class="o">.</span><span class="n">Interaction</span><span class="p">(</span><span class="n">ham_params</span><span class="p">[</span><span class="s2">&quot;exchange&quot;</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="c1"># Dipolar and exchange coupling between triplets b and c</span>
    <span class="c1"># Note: we set the frame of the second triplet because the b-c pair</span>
    <span class="c1"># is rotated relative to the a-b pair</span>
    <span class="n">diploar_bc</span> <span class="o">=</span> <span class="n">spin_model</span><span class="o">.</span><span class="n">DEInteraction</span><span class="p">(</span><span class="n">ham_params</span><span class="p">[</span><span class="s2">&quot;dipolar&quot;</span><span class="p">],</span>  <span class="n">frame</span><span class="o">=</span><span class="n">relative_euler_angles_b</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">exchange_bc</span> <span class="o">=</span> <span class="n">spin_model</span><span class="o">.</span><span class="n">DEInteraction</span><span class="p">(</span><span class="n">ham_params</span><span class="p">[</span><span class="s2">&quot;exchange&quot;</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="n">base_spin_system</span> <span class="o">=</span> <span class="n">spin_model</span><span class="o">.</span><span class="n">SpinSystem</span><span class="p">(</span>
        <span class="n">electrons</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
        <span class="n">g_tensors</span><span class="o">=</span><span class="p">[</span><span class="n">g_tensor_1</span><span class="p">,</span> <span class="n">g_tensor_2</span><span class="p">,</span> <span class="n">g_tensor_3</span><span class="p">],</span>
        <span class="n">electron_electron</span><span class="o">=</span><span class="p">[</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">zfs_interaction_1</span><span class="p">),</span>  <span class="c1"># ZFS on triplet 1</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">zfs_interaction_2</span><span class="p">),</span>  <span class="c1"># ZFS on triplet 2</span>
            <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">zfs_interaction_2</span><span class="p">),</span>  <span class="c1"># ZFS on triplet 3</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">diploar_ab</span> <span class="o">+</span> <span class="n">exchange_ab</span><span class="p">),</span>         <span class="c1"># Inter-triplet dipolar coupling between 1 and 2</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">diploar_bc</span> <span class="o">+</span> <span class="n">exchange_bc</span><span class="p">),</span>         <span class="c1"># Inter-triplet dipolar coupling between 2 and 3</span>
        <span class="p">],</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span>
    <span class="p">)</span>

    <span class="n">sample</span> <span class="o">=</span> <span class="n">spin_model</span><span class="o">.</span><span class="n">MultiOrientedSample</span><span class="p">(</span>
        <span class="n">base_spin_system</span><span class="o">=</span><span class="n">base_spin_system</span><span class="p">,</span>
        <span class="n">gauss</span><span class="o">=</span><span class="n">ham_params</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">],</span>
        <span class="n">lorentz</span><span class="o">=</span><span class="n">ham_params</span><span class="p">[</span><span class="s2">&quot;lorentz&quot;</span><span class="p">],</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span> <span class="c1"># Let&#39;s reduce mesh a little bit. These values will be enough</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">sample</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ham_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;g&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">2.02</span><span class="p">,</span> <span class="mf">1.97</span><span class="p">,</span> <span class="mf">2.06</span><span class="p">),</span>          <span class="c1"># Anisotropic g-tensor</span>
    <span class="s2">&quot;DE&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">500e6</span><span class="p">,</span> <span class="mf">100e6</span><span class="p">),</span>             <span class="c1"># ZFS: D = 500 MHz, E = 100 MHz</span>
    <span class="s2">&quot;gauss&quot;</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">,</span>                    <span class="c1"># Gaussian broadening (T)</span>
    <span class="s2">&quot;lorentz&quot;</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">,</span>                  <span class="c1"># Lorentzian broadening (T)</span>
    <span class="s2">&quot;dipolar&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">200e6</span><span class="p">,</span> <span class="mf">40e6</span><span class="p">),</span>         <span class="c1"># Weak inter-triplet coupling</span>
    <span class="s2">&quot;exchange&quot;</span><span class="p">:</span> <span class="mf">1e8</span><span class="p">,</span>                  <span class="c1"># Weak exchange interaction</span>
<span class="p">}</span>


<span class="c1"># Relative orientation of the second triplet (Euler angles in radians)</span>
<span class="n">relative_euler_angles_b</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Find the relative orientation of the c-spin system relative to the a-spin system</span>
<span class="n">rot_matrix</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">euler_angles_to_matrix</span><span class="p">(</span><span class="n">relative_euler_angles_b</span><span class="p">)</span>
<span class="n">rot_matrix</span> <span class="o">=</span> <span class="n">rot_matrix</span> <span class="o">@</span> <span class="n">rot_matrix</span>
<span class="n">relative_euler_angles_c</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">rotation_matrix_to_euler_angles</span><span class="p">(</span><span class="n">rot_matrix</span><span class="p">)</span>

<span class="c1"># Create individual triplet samples</span>
<span class="n">triplet_a_sample</span> <span class="o">=</span> <span class="n">create_triplet_sample</span><span class="p">(</span><span class="n">ham_params</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">triplet_b_sample</span> <span class="o">=</span> <span class="n">create_triplet_sample</span><span class="p">(</span><span class="n">ham_params</span><span class="p">,</span> <span class="n">relative_euler_angles_b</span><span class="p">)</span>
<span class="n">triplet_c_sample</span> <span class="o">=</span> <span class="n">create_triplet_sample</span><span class="p">(</span><span class="n">ham_params</span><span class="p">,</span> <span class="n">relative_euler_angles_c</span><span class="p">)</span>

<span class="c1"># Create coupled system</span>
<span class="n">coupled_system_sample</span> <span class="o">=</span> <span class="n">create_coupled_triplets_sample</span><span class="p">(</span><span class="n">ham_params</span><span class="p">,</span> <span class="n">relative_euler_angles_b</span><span class="p">,</span> <span class="n">relative_euler_angles_c</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualize the energy level system of the coupled sample</span>
<span class="n">visualization</span><span class="o">.</span><span class="n">plot_energy_system</span><span class="p">(</span><span class="n">coupled_system_sample</span><span class="p">,</span> <span class="n">B_range</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_examples_for_documentation_example_7_10_0.png" src="../../_images/examples_examples_for_documentation_example_7_10_0.png" />
</div>
</div>
</section>
<section id="1.2.-Relaxation-Context-for-Time-Resolved-Simulation">
<h2>1.2. Relaxation Context for Time-Resolved Simulation<a class="headerlink" href="#1.2.-Relaxation-Context-for-Time-Resolved-Simulation" title="Link to this heading"></a></h2>
<p>In time-resolved EPR, the initial spin polarization and relaxation pathways determine the observed signal evolution. We define a composite context that combines:</p>
<ol class="arabic simple">
<li><p><strong>Initial populations</strong> in the laboratory (XYZ) basis (e.g., due to photoexcitation)</p></li>
<li><p><strong>Irreversible decay</strong> (<code class="docutils literal notranslate"><span class="pre">out_probs</span></code>) from each sublevel</p></li>
<li><p><strong>Intrasystem transitions</strong>: This is a more complex parameter, as there are several physical models within which this parameter can be written. For example, let’s define intersystem transitions in the multiplet basis of each individual electron: T₋₁, T₀, T₊₁.</p></li>
</ol>
<p>Since the triplet levels are mixed with each other, we will observe a broad distribution of transitions within the spin system of three triplets.</p>
<p><strong>MarS context algebra:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">+</span></code> → summation of independent relaxation mechanisms on the same system</p></li>
<li><p>:def:<code class="docutils literal notranslate"><span class="pre">population.multiply_contexts</span></code> → multiply several triplet mechanisms</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_context</span><span class="p">(</span>
    <span class="n">initial_populations_xyz</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="n">triplet_a_sample</span><span class="p">:</span> <span class="n">spin_model</span><span class="o">.</span><span class="n">MultiOrientedSample</span><span class="p">,</span>
    <span class="n">triplet_b_sample</span><span class="p">:</span> <span class="n">spin_model</span><span class="o">.</span><span class="n">MultiOrientedSample</span><span class="p">,</span>
    <span class="n">triplet_c_sample</span><span class="p">:</span> <span class="n">spin_model</span><span class="o">.</span><span class="n">MultiOrientedSample</span><span class="p">,</span>
    <span class="n">intra_triplet_rate_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">out_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">100.0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">population</span><span class="o">.</span><span class="n">Context</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct a composite relaxation context for three coupled triplet states.</span>

<span class="sd">    This function builds a full relaxation model for a system of three S=1 triplets,</span>
<span class="sd">    combining:</span>
<span class="sd">    - Non-Boltzmann initial spin polarization in the laboratory (XYZ) basis</span>
<span class="sd">    - Irreversible depopulation (&quot;out&quot; probabilities)</span>
<span class="sd">    - Internal thermalization within each triplet in the |T₋₁⟩, |T₀⟩, |T₊₁⟩ basis</span>

<span class="sd">    The resulting context can be used with time-resolved or stationary spectra</span>
<span class="sd">    simulators in MarS.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    initial_populations_xyz : list[float]</span>
<span class="sd">        Initial populations in the XYZ basis for each triplet, given as</span>
<span class="sd">        [Tx, Ty, Tz].</span>
<span class="sd">        Example: [0.1, 0.3, 0.6].  X, Y, Z</span>

<span class="sd">    triplet_a_sample : MultiOrientedSample</span>
<span class="sd">        Spin system sample representing the first triplet state.</span>

<span class="sd">    triplet_b_sample : MultiOrientedSample</span>
<span class="sd">        Spin system sample representing the second triplet state</span>

<span class="sd">    triplet_c_sample : MultiOrientedSample</span>
<span class="sd">        Spin system sample representing the third triplet state</span>

<span class="sd">    intra_triplet_rate_scale : float, optional</span>
<span class="sd">        Scaling factor (in s⁻¹) for internal probabilities transition between</span>
<span class="sd">        sublevels within a triplet.</span>

<span class="sd">    out_rate : float, optional</span>
<span class="sd">        Irreversible depopulation rate (s⁻¹) applied equally to all three</span>
<span class="sd">        sublevels of both triplets</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    population.Context</span>
<span class="sd">        Composite relaxation context for the two-triplet system</span>

<span class="sd">    The total context is built as:</span>
<span class="sd">        (context_A_XYZ + context_A_multiplet) ⊗ (context_B_XYZ + context_B_multiplet) ⊗ (context_C_XYZ + context_C_multiplet)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Irreversible depopulation rate (same for all sublevels): 100 s⁻¹ → τ ≈ 10 ms</span>
    <span class="n">out_rates</span> <span class="o">=</span> <span class="p">[</span><span class="n">out_rate</span><span class="p">,</span> <span class="n">out_rate</span><span class="p">,</span> <span class="n">out_rate</span><span class="p">]</span>  <span class="c1"># in s⁻¹</span>

    <span class="c1"># Internal thermalization within each triplet (~1 ms equilibration time)</span>
    <span class="n">intra_triplet_rates</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span>
        <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>   <span class="c1"># T-1 -&gt; T0</span>
        <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>   <span class="c1"># T0 -&gt; T-1 and T0 -&gt; T+1</span>
        <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>    <span class="c1"># T+1 -&gt; T0</span>
    <span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">intra_triplet_rate_scale</span>


    <span class="c1"># For triplet A: initial polarization + decay in XYZ basis</span>
    <span class="n">context_a_xyz</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span>
        <span class="n">sample</span><span class="o">=</span><span class="n">triplet_a_sample</span><span class="p">,</span>
        <span class="n">basis</span><span class="o">=</span><span class="s2">&quot;xyz&quot;</span><span class="p">,</span>
        <span class="n">init_populations</span><span class="o">=</span><span class="n">initial_populations_xyz</span><span class="p">,</span>
        <span class="n">out_probs</span><span class="o">=</span><span class="n">out_rates</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span>
    <span class="p">)</span>

    <span class="c1"># For triplet A: internal relaxation in multiplet basis T-1, T0, T+1</span>
    <span class="n">context_a_multiplet</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span>
        <span class="n">sample</span><span class="o">=</span><span class="n">triplet_a_sample</span><span class="p">,</span>
        <span class="n">basis</span><span class="o">=</span><span class="s2">&quot;multiplet&quot;</span><span class="p">,</span>
        <span class="n">free_probs</span><span class="o">=</span><span class="n">intra_triplet_rates</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span>
    <span class="p">)</span>

    <span class="c1"># Repeat for triplet B (identical parameters assumed)</span>
    <span class="n">context_b_xyz</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span>
        <span class="n">sample</span><span class="o">=</span><span class="n">triplet_b_sample</span><span class="p">,</span>
        <span class="n">basis</span><span class="o">=</span><span class="s2">&quot;xyz&quot;</span><span class="p">,</span>
        <span class="n">init_populations</span><span class="o">=</span><span class="n">initial_populations_xyz</span><span class="p">,</span>
        <span class="n">out_probs</span><span class="o">=</span><span class="n">out_rates</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span>
    <span class="p">)</span>

    <span class="n">context_b_multiplet</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span>
        <span class="n">sample</span><span class="o">=</span><span class="n">triplet_b_sample</span><span class="p">,</span>
        <span class="n">basis</span><span class="o">=</span><span class="s2">&quot;multiplet&quot;</span><span class="p">,</span>
        <span class="n">free_probs</span><span class="o">=</span><span class="n">intra_triplet_rates</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span>
    <span class="p">)</span>


    <span class="c1"># Repeat for triplet C (identical parameters assumed)</span>
    <span class="n">context_c_xyz</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span>
        <span class="n">sample</span><span class="o">=</span><span class="n">triplet_c_sample</span><span class="p">,</span>
        <span class="n">basis</span><span class="o">=</span><span class="s2">&quot;xyz&quot;</span><span class="p">,</span>
        <span class="n">init_populations</span><span class="o">=</span><span class="n">initial_populations_xyz</span><span class="p">,</span>
        <span class="n">out_probs</span><span class="o">=</span><span class="n">out_rates</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span>
    <span class="p">)</span>

    <span class="n">context_c_multiplet</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span>
        <span class="n">sample</span><span class="o">=</span><span class="n">triplet_c_sample</span><span class="p">,</span>
        <span class="n">basis</span><span class="o">=</span><span class="s2">&quot;multiplet&quot;</span><span class="p">,</span>
        <span class="n">free_probs</span><span class="o">=</span><span class="n">intra_triplet_rates</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span>
    <span class="p">)</span>

    <span class="c1"># Combine mechanisms per triplet, then form multiplied system.</span>
    <span class="c1"># It is better to do it manually via multiply contexts then by @ operation</span>
    <span class="n">total_relaxation_context</span> <span class="o">=</span> <span class="n">population</span><span class="o">.</span><span class="n">multiply_contexts</span><span class="p">((</span>
        <span class="p">(</span><span class="n">context_a_xyz</span> <span class="o">+</span> <span class="n">context_a_multiplet</span><span class="p">),</span>
        <span class="p">(</span><span class="n">context_b_xyz</span> <span class="o">+</span> <span class="n">context_b_multiplet</span><span class="p">),</span>
        <span class="p">(</span><span class="n">context_c_xyz</span> <span class="o">+</span> <span class="n">context_c_multiplet</span><span class="p">),</span>
    <span class="p">))</span>
    <span class="k">return</span> <span class="n">total_relaxation_context</span>
</pre></div>
</div>
</div>
</section>
<section id="1.3.-Simulate-Stationary-Spectrum">
<h2>1.3. Simulate Stationary Spectrum<a class="headerlink" href="#1.3.-Simulate-Stationary-Spectrum" title="Link to this heading"></a></h2>
<p>Although this notebook focuses on time-resolved modeling, it’s useful to inspect the steady-state spectrum under the defined polarization:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">total_context</span> <span class="o">=</span> <span class="n">get_context</span><span class="p">(</span>
    <span class="n">initial_populations_xyz</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>  <span class="c1"># Set some values. Let is be [0.2, 0.3, 0.5]</span>
    <span class="n">intra_triplet_rate_scale</span> <span class="o">=</span> <span class="mf">20.0</span><span class="p">,</span>
    <span class="n">out_rate</span> <span class="o">=</span> <span class="mf">100.0</span><span class="p">,</span>
    <span class="n">triplet_a_sample</span><span class="o">=</span><span class="n">triplet_a_sample</span><span class="p">,</span>
    <span class="n">triplet_b_sample</span><span class="o">=</span><span class="n">triplet_b_sample</span><span class="p">,</span>
    <span class="n">triplet_c_sample</span><span class="o">=</span><span class="n">triplet_c_sample</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">spectra_creator</span> <span class="o">=</span> <span class="n">spectra_manager</span><span class="o">.</span><span class="n">StationarySpectra</span><span class="p">(</span>
    <span class="n">freq</span><span class="o">=</span><span class="mf">9.8e9</span><span class="p">,</span>    <span class="c1"># Frequency in Hz</span>
    <span class="n">sample</span><span class="o">=</span><span class="n">coupled_system_sample</span><span class="p">,</span>
    <span class="n">harmonic</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>      <span class="c1"># absorbtion</span>
    <span class="n">context</span><span class="o">=</span><span class="n">total_context</span><span class="p">,</span>
    <span class="n">temperature</span><span class="o">=</span><span class="mf">300.0</span><span class="p">,</span>  <span class="c1"># Room temperature (K)</span>
    <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span>
<span class="p">)</span>

<span class="n">fields</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>  <span class="c1"># Field in Tesla</span>
<span class="n">spectrum</span> <span class="o">=</span> <span class="n">spectra_creator</span><span class="p">(</span><span class="n">coupled_system_sample</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Field (T)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Intensity (arb. units)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Stationary Spectrum of Coupled Triplets with Spin Polarization&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_examples_for_documentation_example_7_15_0.png" src="../../_images/examples_examples_for_documentation_example_7_15_0.png" />
</div>
</div>
</section>
<section id="1.4.-Syntetic-Spectra-Creation">
<h2>1.4. Syntetic Spectra Creation<a class="headerlink" href="#1.4.-Syntetic-Spectra-Creation" title="Link to this heading"></a></h2>
<p>As in previous examples (notebook 3), let’s generate some synthetic spectra to fit later.</p>
<p><strong>Important Note:</strong> Unfortunately, we cannot perform a full simulation for such a system in Liouville space. The system is too large - 27 levels and approximately 100 transitions between them. Therefore, let’s construct the relaxation starting at 10 µs, when the T₂ relaxation has already finished.</p>
<p>For <code class="docutils literal notranslate"><span class="pre">CoupledTimeSpectra</span></code>, generating one spectrum takes approximately 10-20 seconds.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set ground Truth parameters:</span>
<span class="n">total_context</span> <span class="o">=</span> <span class="n">get_context</span><span class="p">(</span>
    <span class="n">initial_populations_xyz</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>  <span class="c1"># Set some values. Let is be [0.2, 0.3, 0.5]</span>
    <span class="n">intra_triplet_rate_scale</span> <span class="o">=</span> <span class="mf">20.0</span><span class="p">,</span>
    <span class="n">out_rate</span> <span class="o">=</span> <span class="mf">100.0</span><span class="p">,</span>
    <span class="n">triplet_a_sample</span><span class="o">=</span><span class="n">triplet_a_sample</span><span class="p">,</span>
    <span class="n">triplet_b_sample</span><span class="o">=</span><span class="n">triplet_b_sample</span><span class="p">,</span>
    <span class="n">triplet_c_sample</span><span class="o">=</span><span class="n">triplet_c_sample</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tr_spectra_creator</span> <span class="o">=</span> <span class="n">spectra_manager</span><span class="o">.</span><span class="n">CoupledTimeSpectra</span><span class="p">(</span>
    <span class="n">freq</span><span class="o">=</span><span class="mf">9.8</span>  <span class="o">*</span> <span class="mf">1e9</span><span class="p">,</span>
    <span class="n">sample</span><span class="o">=</span><span class="n">coupled_system_sample</span><span class="p">,</span>
    <span class="n">harmonic</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>                             <span class="c1"># Absorption mode</span>
    <span class="n">context</span><span class="o">=</span><span class="n">total_context</span><span class="p">,</span>
    <span class="n">temperature</span><span class="o">=</span><span class="mf">300.0</span><span class="p">,</span>
    <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span>
<span class="p">)</span>

<span class="c1"># Define simulation axes</span>
<span class="n">fields</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.30</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>       <span class="c1"># Tesla</span>
<span class="n">time</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1e-5</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>        <span class="c1"># Seconds (from 10 us to 500 us)</span>

<span class="c1"># Simulate ground truth spectrum</span>
<span class="n">spectrum_gt</span> <span class="o">=</span> <span class="n">tr_spectra_creator</span><span class="p">(</span><span class="n">coupled_system_sample</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>

<span class="c1"># Add experimental noise (5% Gaussian noise)</span>
<span class="n">noise_level</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">noise</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">spectrum_gt</span><span class="p">)</span> <span class="o">*</span> <span class="n">noise_level</span> <span class="o">*</span> <span class="n">spectrum_gt</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">spectrum_exp</span> <span class="o">=</span> <span class="n">spectrum_gt</span> <span class="o">+</span> <span class="n">noise</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated synthetic spectrum with shape: </span><span class="si">{</span><span class="n">spectrum_exp</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Noise level: </span><span class="si">{</span><span class="n">noise_level</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% of max intensity&quot;</span><span class="p">)</span>
<span class="n">visualization</span><span class="o">.</span><span class="n">plot_2d_timeresolved</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">spectrum_gt</span><span class="p">,</span> <span class="n">time_unit</span><span class="o">=</span><span class="s2">&quot;ms&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Syntetic Spectra for Fitting&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Generated synthetic spectrum with shape: torch.Size([100, 500])
Noise level: 5.0% of max intensity
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_examples_for_documentation_example_7_19_1.png" src="../../_images/examples_examples_for_documentation_example_7_19_1.png" />
</div>
</div>
</section>
</section>
<section id="2.-Fitting-Time-Resolved-Spectra">
<h1>2. Fitting Time-Resolved Spectra<a class="headerlink" href="#2.-Fitting-Time-Resolved-Spectra" title="Link to this heading"></a></h1>
<p>In this section, we will fit the <code class="docutils literal notranslate"><span class="pre">intra_triplet_rate_scale</span></code> parameter using the synthetic time-resolved spectrum generated in section 1.</p>
<p><strong>Workflow:</strong></p>
<ol class="arabic simple">
<li><p>Define the parameter space for optimization</p></li>
<li><p>Create a 2D spectra simulator that can update the relaxation context</p></li>
<li><p>Set up the Spectrum2DFitter</p></li>
<li><p>Run optimization using Bayes Oprimizer</p></li>
</ol>
<section id="2.1.-Define-Parameter-Space-for-Fitting">
<h2>2.1. Define Parameter Space for Fitting<a class="headerlink" href="#2.1.-Define-Parameter-Space-for-Fitting" title="Link to this heading"></a></h2>
<p>We will fit only the <code class="docutils literal notranslate"><span class="pre">intra_triplet_rate_scale</span></code> parameter while keeping all Hamiltonian parameters fixed. This is a common scenario in time-resolved EPR where the spin system can be already characterized but relaxation dynamics need to be determined.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">mars.optimization</span><span class="w"> </span><span class="kn">import</span> <span class="n">ParameterSpace</span><span class="p">,</span> <span class="n">ParamSpec</span><span class="p">,</span> <span class="n">Spectrum2DFitter</span><span class="p">,</span> <span class="n">print_trial_results</span>

<span class="c1"># Define the parameter to fit</span>
<span class="n">param_specs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">ParamSpec</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;intra_triplet_rate_scale&quot;</span><span class="p">,</span>
        <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">),</span>  <span class="c1"># Some Reasonable range for internal relaxation rates</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">50.0</span><span class="p">,</span>
        <span class="n">vary</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">),</span>
<span class="p">]</span>

<span class="c1"># Fixed parameters include parameters that we need to create context.</span>
<span class="c1"># We do not need to change samples or create new samples. So we do not use Hamiltonian parameters here</span>
<span class="n">param_space_fit</span> <span class="o">=</span> <span class="n">ParameterSpace</span><span class="p">(</span>
    <span class="n">specs</span><span class="o">=</span><span class="n">param_specs</span><span class="p">,</span>
    <span class="n">fixed_params</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;out_rate&quot;</span><span class="p">:</span> <span class="mf">100.0</span><span class="p">,</span>
        <span class="s2">&quot;initial_populations_xyz&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">param_space_fit</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Some stuff might fail: issue in joblib
[KeOps] Warning : No C++ compiler found. Define CXX environment variable or install g++.
[KeOps] Warning : No C++ compiler found. You need to either define the CXX environment variable pointing to a valid compiler, or ensure that &#39;g++&#39; is installed and in your PATH.
[KeOps] Warning : CUDA libraries not found or could not be loaded; Switching to CPU only.
[KeOps] Warning : No C++ compiler found. You need to either define the CXX environment variable pointing to a valid compiler, or ensure that &#39;g++&#39; is installed and in your PATH.
[KeOps] Warning : No C++ compiler available to check for OpenMP support.
[KeOps] Warning : OpenMP support is not available. Disabling OpenMP.
____Fixed parameters_____
----------------------------------------
  out_rate                =        100.0000
  initial_populations_xyz = [0.2, 0.3, 0.5]


______Varying parameters_____
----------------------------------------
  intra_triplet_rate_scale =         50.0000   (low:   +5.0000  up:   +100.0000)

</pre></div></div>
</div>
</section>
<section id="2.2.-Create-Time-Resolved-Spectra-Simulator">
<h2>2.2. Create Time-Resolved Spectra Simulator<a class="headerlink" href="#2.2.-Create-Time-Resolved-Spectra-Simulator" title="Link to this heading"></a></h2>
<p>The simulator must accept three arguments: <code class="docutils literal notranslate"><span class="pre">fields</span></code>, <code class="docutils literal notranslate"><span class="pre">times</span></code>, and <code class="docutils literal notranslate"><span class="pre">params</span></code>. It will create a new relaxation context based on the optimization parameters and calculate the 2D spectrum.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TRSpectraSimulator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simulator for time-resolved EPR spectra.</span>

<span class="sd">    This simulator creates a CoupledTimeSpectra object and updates the</span>
<span class="sd">    relaxation context based on the optimization parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">coupled_system_sample</span><span class="p">,</span>
        <span class="n">triplet_a_sample</span><span class="p">,</span>
        <span class="n">triplet_b_sample</span><span class="p">,</span>
        <span class="n">triplet_c_sample</span><span class="p">,</span>
        <span class="n">device</span><span class="p">,</span>
        <span class="n">dtype</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coupled_system_sample</span> <span class="o">=</span> <span class="n">coupled_system_sample</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">triplet_a_sample</span> <span class="o">=</span> <span class="n">triplet_a_sample</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">triplet_b_sample</span> <span class="o">=</span> <span class="n">triplet_b_sample</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">triplet_c_sample</span> <span class="o">=</span> <span class="n">triplet_c_sample</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">spectra_manager</span> <span class="o">=</span> <span class="n">spectra_manager</span><span class="o">.</span><span class="n">CoupledTimeSpectra</span><span class="p">(</span>
            <span class="n">freq</span><span class="o">=</span><span class="mf">9.8</span> <span class="o">*</span> <span class="mf">1e9</span><span class="p">,</span>
            <span class="n">sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coupled_system_sample</span><span class="p">,</span>
            <span class="n">harmonic</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># Initialize with None. Then we will pas in forward the current context</span>
            <span class="n">temperature</span><span class="o">=</span><span class="mf">300.0</span><span class="p">,</span>
            <span class="c1"># Here we disable computation of eigen parameters since we can compute it only for the first iteration and cach them.</span>
            <span class="n">recompute_spin_parameters</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate 2D time-resolved spectrum for given parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fields : torch.Tensor</span>
<span class="sd">            Magnetic field values (T)</span>
<span class="sd">        times : torch.Tensor</span>
<span class="sd">            Time values (s)</span>
<span class="sd">        params : dict</span>
<span class="sd">            Parameter dictionary containing context parameters</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        spectrum_2d : torch.Tensor</span>
<span class="sd">            2D spectrum with shape (len(times), len(fields))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create context with updated relaxation parameters</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">get_context</span><span class="p">(</span>
            <span class="n">initial_populations_xyz</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;initial_populations_xyz&quot;</span><span class="p">],</span>
            <span class="n">triplet_a_sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">triplet_a_sample</span><span class="p">,</span>
            <span class="n">triplet_b_sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">triplet_b_sample</span><span class="p">,</span>
            <span class="n">triplet_c_sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">triplet_c_sample</span><span class="p">,</span>
            <span class="n">intra_triplet_rate_scale</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;intra_triplet_rate_scale&quot;</span><span class="p">],</span>
            <span class="n">out_rate</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;out_rate&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># Create time-resolved spectra calculator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectra_manager</span><span class="o">.</span><span class="n">update_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

        <span class="c1"># Calculate and return 2D spectrum</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra_manager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coupled_system_sample</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">spectrum</span>
</pre></div>
</div>
</div>
</section>
<section id="2.3.-Initialize-the-2D-Spectrum-Fitter">
<h2>2.3. Initialize the 2D Spectrum Fitter<a class="headerlink" href="#2.3.-Initialize-the-2D-Spectrum-Fitter" title="Link to this heading"></a></h2>
<p>Now we create the <code class="docutils literal notranslate"><span class="pre">Spectrum2DFitter</span></code> object. This is the 2D analog of <code class="docutils literal notranslate"><span class="pre">SpectrumFitter</span></code> used in Example 3.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create the simulator instance</span>
<span class="n">tr_simulator</span> <span class="o">=</span> <span class="n">TRSpectraSimulator</span><span class="p">(</span>
    <span class="n">coupled_system_sample</span><span class="o">=</span><span class="n">coupled_system_sample</span><span class="p">,</span>
    <span class="n">triplet_a_sample</span><span class="o">=</span><span class="n">triplet_a_sample</span><span class="p">,</span>
    <span class="n">triplet_b_sample</span><span class="o">=</span><span class="n">triplet_b_sample</span><span class="p">,</span>
    <span class="n">triplet_c_sample</span><span class="o">=</span><span class="n">triplet_c_sample</span><span class="p">,</span>
    <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span>
<span class="p">)</span>

<span class="c1"># Create the 2D fitter</span>
<span class="n">fitter_2d</span> <span class="o">=</span> <span class="n">Spectrum2DFitter</span><span class="p">(</span>
    <span class="n">x1_exp</span><span class="o">=</span><span class="n">fields</span><span class="p">,</span>           <span class="c1"># Magnetic field axis (T)</span>
    <span class="n">x2_exp</span><span class="o">=</span><span class="n">time</span><span class="p">,</span>             <span class="c1"># Time axis (s)</span>
    <span class="n">y_exp</span><span class="o">=</span><span class="n">spectrum_exp</span><span class="p">,</span>      <span class="c1"># 2D experimental data (with noise)</span>
    <span class="n">param_space</span><span class="o">=</span><span class="n">param_space_fit</span><span class="p">,</span>
    <span class="n">spectra_simulator</span><span class="o">=</span><span class="n">tr_simulator</span><span class="p">,</span>
    <span class="n">norm_mode</span><span class="o">=</span><span class="s2">&quot;max&quot;</span><span class="p">,</span>         <span class="c1"># Normalize by maximum intensity</span>
    <span class="n">device</span><span class="o">=</span><span class="n">device</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
D:\ITC\РНФ_Курганский_2024\pythonProject\MarS\mars\optimization\fitter.py:1035: UserWarning: To copy construct from a tensor, it is recommended to use sourceTensor.clone().detach() or sourceTensor.clone().detach().requires_grad_(True), rather than torch.tensor(sourceTensor).
  x1_exp = torch.tensor(x1_exp, dtype=torch.float32, device=self.device)
D:\ITC\РНФ_Курганский_2024\pythonProject\MarS\mars\optimization\fitter.py:1036: UserWarning: To copy construct from a tensor, it is recommended to use sourceTensor.clone().detach() or sourceTensor.clone().detach().requires_grad_(True), rather than torch.tensor(sourceTensor).
  x2_exp = torch.tensor(x2_exp, dtype=torch.float32, device=self.device)
D:\ITC\РНФ_Курганский_2024\pythonProject\MarS\mars\optimization\fitter.py:1037: UserWarning: To copy construct from a tensor, it is recommended to use sourceTensor.clone().detach() or sourceTensor.clone().detach().requires_grad_(True), rather than torch.tensor(sourceTensor).
  y_exp = torch.tensor(y_exp, dtype=torch.float32, device=self.device)
</pre></div></div>
</div>
</section>
<section id="2.4.-Fitting-with-Optuna_integration">
<h2>2.4. Fitting with Optuna_integration<a class="headerlink" href="#2.4.-Fitting-with-Optuna_integration" title="Link to this heading"></a></h2>
<p>In this section, we explore an advanced optimization strategy using optuna-integration (<a class="reference external" href="https://optuna-integration.readthedocs.io/en/stable/reference/index.html">https://optuna-integration.readthedocs.io/en/stable/reference/index.html</a>) - an extension of the standard Optuna library that provides access to state-of-the-art samplers from external frameworks.</p>
<p>One particularly option is the BoTorchSampler, which leverages Bayesian optimization via the BoTorch library (a probabilistic modeling and optimization framework built on PyTorch). Bayesian optimization is well-suited for expensive-to-evaluate objective functions, such as our case.</p>
<p>Key advantages in our context:</p>
<ol class="arabic simple">
<li><p>Efficient global optimization: Bayesian optimization builds a probabilistic surrogate model of the objective function and uses it to intelligently select the next set of parameters to evaluate. This often leads to faster convergence to high-quality minima compared to traditional methods.</p></li>
<li><p>Computational overhead: A single Bayesian optimization step typically takes ~1 second. Given that each spectral simulation in our workflow requires 5–20 seconds, this additional cost is minimal and well justified by the potential gains in sample efficiency.</p></li>
</ol>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">optuna_integration</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sampler</span> <span class="o">=</span> <span class="n">optuna_integration</span><span class="o">.</span><span class="n">BoTorchSampler</span><span class="p">()</span>

<span class="n">result_botorch</span> <span class="o">=</span> <span class="n">fitter_2d</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;optuna&quot;</span><span class="p">,</span>
    <span class="n">n_trials</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rate_botorch</span> <span class="o">=</span> <span class="n">result_botorch</span><span class="o">.</span><span class="n">best_params</span><span class="p">[</span><span class="s2">&quot;intra_triplet_rate_scale&quot;</span><span class="p">]</span>
<span class="n">best_fit</span> <span class="o">=</span> <span class="n">result_botorch</span><span class="o">.</span><span class="n">best_spectrum</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Plot 1: Ground truth</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">visualization</span><span class="o">.</span><span class="n">plot_2d_timeresolved</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">spectrum_gt</span><span class="p">,</span> <span class="n">time_unit</span><span class="o">=</span><span class="s2">&quot;ms&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;round Truth Spectrum (rate_scale = 20.0)&quot;</span><span class="p">)</span>

<span class="c1"># Plot 2: BoTorch fit</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">visualization</span><span class="o">.</span><span class="n">plot_2d_timeresolved</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">best_fit</span><span class="p">,</span> <span class="n">time_unit</span><span class="o">=</span><span class="s2">&quot;ms&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;botorch Fit (rate_scale = </span><span class="si">{</span><span class="n">rate_botorch</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
C:\Users\User\AppData\Local\Temp\ipykernel_22300\1770759704.py:4: MatplotlibDeprecationWarning: Auto-removal of overlapping axes is deprecated since 3.6 and will be removed two minor releases later; explicitly call ax.remove() as needed.
  plt.subplot(1, 2, 1)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 1.0, &#39;botorch Fit (rate_scale = 30.54)&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_examples_for_documentation_example_7_31_2.png" src="../../_images/examples_examples_for_documentation_example_7_31_2.png" />
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../example_7.html" class="btn btn-neutral float-left" title="Time-Resolved Fitting Procedures" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2026, Arkady Samsonenko, Ivan Kurgansky.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>